name: test
on: [pull_request, push]

jobs:
  test:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout Master Project
      uses: actions/checkout@v4
      with:
        repository: porkyoot/piggy-mods
        submodules: true
        path: .
        
    - name: Checkout Submodule (Current)
      uses: actions/checkout@v4
      with:
        path: piggy-admin
        
    - name: Validate Gradle Wrapper
      uses: gradle/actions/wrapper-validation@v4
      
    - name: Setup JDK
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'microsoft'
        
    - name: Make Gradle Wrapper Executable
      run: chmod +x ./gradlew
      
    - name: Isolate Project Dependencies
      run: |
        cat <<EOF > settings.gradle
        pluginManagement {
            repositories {
                maven {
                    name = 'Fabric'
                    url = 'https://maven.fabricmc.net/'
                }
                gradlePluginPortal()
            }
        }
        rootProject.name = 'piggy-mods'
        
        // Only include the shared library and THIS mod
        include 'piggy-lib'
        include 'piggy-admin'
        EOF
        
    - name: Run piggy-admin tests
      run: ./gradlew :piggy-admin:runGametest
      
    - name: Test Summary
      if: always()
      run: |
        echo "## Piggy Admin - GameTest Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **11 tests** covering:" >> $GITHUB_STEP_SUMMARY
        echo "- Config state management" >> $GITHUB_STEP_SUMMARY
        echo "- Sign & chat logging" >> $GITHUB_STEP_SUMMARY
        echo "- History retrieval" >> $GITHUB_STEP_SUMMARY
        echo "- XRay detection anti-cheat" >> $GITHUB_STEP_SUMMARY
